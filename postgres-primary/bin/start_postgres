#!/bin/bash

# Paths to things
DATADIR=/postgres/data
BACKUPDIR=/postgres/backup/

mkdir -p $BACKUPDIR

# Lazily initialize database if needed
if [[ ! -f $DATADIR/PG_VERSION ]]
then
  # Initialize the data directory
  initdb $DATADIR -U postgres

  # apply minimal configuration
  cp -f /usr/local/etc/postgres/*.conf $DATADIR/

  # set up default databases etc
  cat /usr/local/scripts/init.sql | postgres \
    --single -D $DATADIR postgres

fi

#exec echo "zip -r /wals/initial.zip $DATADIR"
#exec 
#zip -r /wals/initial.zip $DATADIR
postgres -D $DATADIR >logfile 2>&1 &

sleep 10

pg_basebackup -h localhost -D $BACKUPDIR
/wal-g.sh backup-push $BACKUPDIR

# Run postgres in the foreground
#exec
#postgres -D $DATADIR

#sleep infinity
tail -f logfile